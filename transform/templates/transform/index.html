{% load staticfiles %}
<!DOCTYPE HTML>
<html lang="el-GR">
	<head>
    <title>SurvGR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    .vertical-align {
      display: flex;
      align-items: center;
    } 
    </style>
    <!--jQuery-->
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script> 
    <!--Open Layers 3-->
    <link rel="stylesheet" href="http://openlayers.org/en/v3.11.1/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.11.1/build/ol.js" type="text/javascript"></script>
    <!--Bootstrap 3-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script src="{% static 'transgr/transform.js' %}"></script>
  </head>

  <body>
    
    <div class="container">
      <div class="page-header">
        <h1>SurvGR  <small>Μετασχηματισμός συντεταγμένων</small></h1>
      </div>

      {% regroup ref_systems|dictsortreversed:"datum" by datum as datums %}
    	<form id="input-params" class="form-vertical" role="form" method="post" action="{% url 'transform' %}">    
        <div class="row"> <!--Reference system selection row -->
          <div class="form-group col-sm-6"> 
            <label for="from-srid" class="form-control-label" >Από το σύστημα αναφοράς:</label>
            <select id="from-srid" name="from_srid" class="form-control">
      			{% for datum in datums %}
       				<optgroup label="{{ datum.grouper }}">
      				{% for refsys in datum.list %}
      					<option value="{{ refsys.srid }}">{{ refsys.name }}</option>
      				{% endfor %}
      				</optgroup>
      			{% endfor %}
      			</select>
          </div>
          <div class="form-group col-sm-6">
            <label for="to-srid" class="form-control-label">Προς το σύστημα αναφοράς:</label>          
            <select id="to-srid" name="to_srid" class="form-control">
            {% for datum in datums %}
              <optgroup label="{{ datum.grouper }}">
              {% for refsys in datum.list %}
                <option value="{{ refsys.srid }}">{{ refsys.name }}</option>
              {% endfor %}
              </optgroup>
            {% endfor %}
            </select>
          </div>
        </div>
        <div class="row"> <!--Hatt block selection row-->
          <div class="form-group col-sm-6">
            <label for="from-hatt-id" class="form-control-label">Από το φύλλο χάρτη:</label>
            <input id="from-hatt-id" name="from_hatt_id" class="form-control" type="text"></input>
          </div>
          <div class="form-group col-sm-6">
            <label for="to-hatt-id" class="form-control-label">Πρός το φύλλο χάρτη:</label>
            <input id="to-hatt-id" name="to_hatt_id" class="form-control" type="text"></input>
          </div>
        </div>
      </form>
      <hr>
      
      <div class="row vertical-align">
        <div class="form-group col-sm-6">
          <label for="input-points" class="form-control-label">Εισαγωγή σημείων:</label>
          <textarea id="input-points" class="form-control" rows="10"></textarea>
        </div>  
        <div class="col-sm-2">
          <button class="btn btn-primary form-control">Go</button>
        </div>
        <div class="form-group col-sm-6">
          <label for="output-points" class="form-control-label">Μετασχηματισμένα σημεία:</label>
          <textarea id="output-points" class="form-control" rows="10"></textarea>
        </div>
      </div>
      <div class="row">
        
      </div>
      
    </div> <!--container-->
  	
  
  	<script type="text/javascript">	
      $(function() {
  				var inputText = $('#input_text');
          console.log(util.pointParser.parseLine('s1 1000'));
         
          var getParams = function(){
            var params = {
              from_srid:parseInt($('#from_srid').val()),
              to_srid:parseInt($('#to_srid').val()),
              from_hatt_id:parseInt($('#from_hatt_id').val()),
              to_hatt_id:parseInt($('#to_hatt_id').val())
            };
            for (var p in params){
              if (!params[p]){
                delete params[p];
              }
            }
            return params;
          };
          var getPoints = function(){       
            var points = [];
            $(input_text).val().split('\n').forEach(function(line) {
              var words = line.split(' ');
              var pt = {
                'type':'Point',
                'coordinates':[parseFloat(words[0]), parseFloat(words[1])]
              };
              points.push(pt);
            });
            return points;
          };

          var setPoints = function(points){
            var lines = []
            points.forEach(function(pt){
              var coordsString = '';
              pt.coordinates.forEach(function(coord){
                coordsString += coord + ' ';
              });
              lines.push(coordsString);
            });
            $('#output_text').val(lines.join('\n'));
          }

          $('#input_params').submit(function(e){
            e.preventDefault();   
            $.ajax({
              type: 'POST',
              url: $(this).attr('action'),
              dataType: 'json',
              contentType: 'application/json;charset=utf-8',
              data: JSON.stringify({
                params:getParams(), 
                geometries:getPoints()
              })
             }).done(function(response){
              ;
              setPoints(response.geometries);
            });  
          });
      });
  	</script>


  </body>

</html>