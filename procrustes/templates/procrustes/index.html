{% load static %}

<!doctype html>
<html lang="el-GR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--jQuery-->
    <script src="//code.jquery.com/jquery-2.2.0.min.js"></script>
    <!--Bootstrap 5-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <!--
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/lumen/bootstrap.min.css">
    -->
    <!--Plotly-->
    <script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
    <!--Mathjax-->
    <script src="{% static 'procrustes/js/mathjax_config.js' %}?version=1.3" type="text/javascript"></script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <!--Open Layers 6-->
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.14.0/css/ol.css">
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.14.0/build/ol.js"></script>
    <!--Proj4js-->
    <script src="https://cdn.jsdelivr.net/npm/proj4@2/dist/proj4.min.js"></script>
    <!--Papaparse-->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
    <!-- custom styling -->
    <link href="{% static 'procrustes/css/index.css' %}?version=1.3" rel="stylesheet">
</head>
<body>
    <div class="container pt-5">
        <h1>Προκρούστης
            <small class="text-muted">υπολογισμός βέλτιστου μετασχηματισμού σημείων</small>
        </h1>
        <hr>
        <form id="form_input" method="post" action="{% url 'upload_reference' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <label class="col-form-label col-sm-2" for="{{ form.reference_points.id_for_label }}">
                    {{ form.reference_points.label }}:
                </label>
                <div class="col-sm-10 pb-3">
                    {{ form.reference_points }}
                </div>
                <label class="col-form-label col-sm-2" for="{{ form.validation_points.id_for_label }}">
                    {{ form.validation_points.label }}:
                </label>
                <div class="col-sm-10 pb-3">
                    {{ form.validation_points }}
                </div>
           </div>

           <div class="row pb-3" id="id_points_format">
               <label class="col-form-label col-sm-2" for="{{ form.points_format.id_for_label }}">
                   {{ form.points_format.label }}:
               </label>
               <div class="col-sm-10">
                   {% for radio in form.points_format %}
                   <div class="form-check">
                       {{ radio.tag }}
                       <label class="form-check-label" for="{{ radio.id_for_label }}">
                           {{ radio.choice_label }}
                       </label>
                   </div>
                   {% endfor %}
               </div>
           </div>

           <fieldset class="row pb-3">
               <legend class="col-form-label col-sm-2">
                   {{ form.transformation_type.label }}:
               </legend>
               <div class="col-sm-10">
                   {% for radio in form.transformation_type %}
                   <div class="form-check">
                       {{ radio.tag }}
                       <label class="form-check-label" for="{{ radio.id_for_label }}">
                           {{ radio.choice_label }}
                       </label>
                   </div>
                   {% endfor %}
               </div>
           </fieldset> <!-- transformation_type row-->

           <fieldset class="row pb-3" id="id_residual_correction_type">
               <legend class="col-form-label col-sm-2">
                   {{ form.residual_correction_type.label }}:
               </legend>
               <div class="col-sm-10">
                   {% for radio in form.residual_correction_type %}
                   <div class="form-check">
                       {{ radio.tag }}
                       <label class="form-check-label" for="{{ radio.id_for_label }}">
                           {{ radio.choice_label }}
                       </label>
                   </div>
                   {% endfor %}
               </div>
           </fieldset> <!-- residual_correction_type row-->

           <fieldset class="row pb-3" id="id_cov_function_type">
               <legend class="col-form-label col-sm-2">
                   {{ form.cov_function_type.label }}:
               </legend>
               <div class="col-sm-10">
                   {% for radio in form.cov_function_type %}
                   <div class="form-check">
                       {{ radio.tag }}
                       <label class="form-check-label" for="{{ radio.id_for_label }}">
                           {{ radio.choice_label }}
                       </label>
                   </div>
                   {% endfor %}
               </div>
            </fieldset> <!-- cov_function_type row -->

            <div class="pb-3">
                <button class="btn btn-primary">Υπολόγισε</button>
            </div>
        </form>
    </div>

    <div class="container pt-5">
        <div class="map" id="map">
        </div>
    </div>

    <div class="container pt-5">
        <div class="row">
            <h2>Αποτελέσματα</h2>
            <div class="col-sm-4">
                <div id="output_transformation_params"></div>
            </div>
            <div class="col-sm-8">
                <div id="output_cov_plot"></div>
            </div>
        </div>
    </div>


    <div class="container pt-5">
        <div class="row pb-5">
            <h2>Τι είναι</h2>
            <p> 
            Ο Προκρούστης προσπαθεί να προσεγγίσει, με τη μέθοδο των ελαχίστων τετραγώνων, τον βέλτιστο 2Δ μετασχηματισμό μεταξύ δύο σετ σημείων $(x, y)$ και $(x^{'}, y^{'})$.
            Τα δύο σέτ σημείων έχουν γνωστές συντεταγμένες σε δύο διαφορετικά συστήματα αναφοράς.
            </p>
            <p>
            Δέχεται αρχεία CSV τα οποία περιέχουν σημεία. Το κάθε σημείο αναγράφεται σε ξεχωριστή γραμμή.
            Η κάθε γραμμή μπορεί να περιέχει:
            </p>
            <div>
                <ul>
                    <li>ένα προαιρετικό αναγνωριστικό κωδικό (id) για το σημείο</li>
                    <li>τις 2D προβολικές συντεταγμένες $x, y$ του σημείου στο 1ο σύστημα αναφοράς (source)</li>
                    <li>τις 2D προβολικές συντεταγμένες $x^{'}, y^{'}$ του σημείου στο 2ο συστημα αναφοράς (target)</li>
                </ul>
            </div>
            <p>
            Τα δεδομένα είναι διαχωρισμένα με κόμμα/κενό/tab/ερωτηματικό. Μονάδα μέτρησης για τις προβολικές συντεταγμένες είναι τα μέτρα.
            </p>
            <p>
            Μπορείτε να εισάγετε δύο CSV αρχεία τα οποία θα έχουν το ίδιο format που περιγράφηκε παραπάνω.
            </p>
            <div>
                <ul>
                    <li> Σημεία Αναφοράς (υποχρεωτικό) - Θα χρησιμοποιηθούν για τον υπολογισμό του βέλτιστου μετασχηματισμού</li>
                    <li> Σημεία Επιβεβαίωσης (προαιρετικό) - Θα χρησιμοποιηθούν για την ποιοτικό έλεγχο των αποτελεσμάτων</li>
                </ul>
            </div>
        </div>
        <div class="row pb-5">
            <h2> Μετασχηματισμός</h2>
            <p>
            Δίνεται επιλογή 3 τύπων μετασχηματισμού:
            </p>
            <div>
                <h3>Ομοιότητας</h3>
                <p>
                Οι διαφορές των συστημάτων αναφοράς περιγράφονται από 2 παραμέτρους μετάθεσης $t_x$ και $t_y$
                μία στροφή $\theta$ και ένα συντελεστή κλίμακας $\delta s$
                </p>
                <p>
                $$
                \begin{bmatrix} x^{'} \\ y^{'} \end{bmatrix} = 
                \begin{bmatrix} t_x \\ t_y \end{bmatrix} +
                (1-\delta s) \begin{bmatrix} \cos\theta & \sin\theta \\ -\sin\theta & \cos\theta \end{bmatrix} 
                \begin{bmatrix} x \\ y \end{bmatrix} 
                $$
                </p>
            </div>
            <div>
                <h3>Αφινικός</h3>
                <p>
                Οι διαφορές των συστημάτων αναφοράς περιγράφονται από
                2 παραμέτρους μετάθεσης $t_x$ και $t_y$
                2 στροφές $\theta_x$, $\theta_y$ και 
                2 συντελεστές κλίμακας $\delta s_x$, $\delta s_y$
                </p>
                <p>
                $$
                \begin{bmatrix} x^{'} \\ y^{'} \end{bmatrix} = 
                \begin{bmatrix} t_x \\ t_y \end{bmatrix} +
                \begin{bmatrix} 1-\delta s_x & 0 \\ 0 & 1-\delta s_y \end{bmatrix}
                \begin{bmatrix} \cos\theta_x & \sin\theta_y \\ -\sin\theta_x & \cos\theta_y \end{bmatrix} 
                \begin{bmatrix} x \\ y \end{bmatrix} 
                $$
                </p>
            </div>
            <div>
                <h3>Πολυωνυμικός 2ου βαθμού</h3>
                <p>
                Οι διαφορές των συστημάτων αναφοράς περιγράφονται από 12 παραμέτρους $\alpha_i$ και $\beta_i$
                </p>
                <p>
                $$\begin{aligned}
                x^{'} &= \alpha_0 + \alpha_1 x + \alpha_2 y + \alpha_3 x^{2} + \alpha_4 y^{2} + \alpha_5 xy \\
                y^{'} &= \beta_0 + \beta_1 x + \beta_2 y + \beta_3 x^{2} + \beta_4 y^{2} + \beta_5 xy 
                \end{aligned}
                $$
                </p>
            </div>
        </div>
        <div class="row pb-5">
            <h2>Μοντελοποίηση Υπολοίπων</h2>
            <div>
                <p>
                Τα υπόλοιπα $s_{ref}$ της εφαρμογής του μετασχηματισμού $M$ στα σημεία αναφορας $X_{ref}$ δεν θα είναι μηδενικά,
                λόγω συστηματικών διαφορών και ασυνεπειών των δύο συστημάτων αναφοράς.
                </p>
                <p>
                $$
                X^{'}_{ref} = M X_{ref} + s_{ref}
                $$
                </p>
                <p>
                Ο Προκρούστης δίνει δύο επιλογές για την μοντελοποίηση των υπολοίπων. Με την εφαρμογή τους επιτυγχάνεται
                εκμηδενισμός των υπολοίπων στα σημεία αναφοράς.
                </p>
            </div>
            <div>
                <h3>Σημειακή Προσαρμογή (Collocation)</h3>
                <p>
                Ανακατανομή των υπολοίπων $s_{ref}$ των σημείων αναφοράς $X_{ref}$ στα νέα σημεία 
                προς μετασχηματισμό $X_{new}$ μέσω σημειακής προσαρμογής.
                Τα υπόλοιπα $s_{ref}$ αντιμετωπίζονται ως σήματα και γίνεται πρόγνωση σημάτων
                στα $X_{new}$. Για την πρόγνωση υπολογίζεται συνάρτηση $f_c(d)$ πού περιγράφει 
                την συμμετάβλητότητα $C$ του σήματος σε ένα σημείο στην περιοχή ενδιαφέροντος, με βάση την απόστασή του $d$ 
                από τα σημεία αναφοράς.
                </p>
                <p>
                $$
                X^{'}_{ref} = M X_{ref}
                $$
                $$
                X^{'}_{new} = M X_{new} + C_{new, ref} C^{-1}_{ref, ref} s_{ref}
                $$
                </p>
            </div>
            <div>
                <h3>Διόρθωση Hausbrandt</h3>
                <p>
                Ανακατανομή των υπολοίπων $s_{ref}$ των σημείων αναφοράς $X_{ref}$ στα νέα σημεία 
                προς μετασχηματισμό $X_{new}$ μέσω παρεμβολής.
                Η παρεμβολή χρησιμοποιεί βάρος $w$, ίσο με το αντίστροφο του τετραγώνου 
                της απόστασης του νέου σημείου από τα σημεία αναφοράς.
                </p>
                <p>
                $$
                X^{'}_{ref} = M X_{ref}
                $$
                $$
                X^{'}_{new} = M X_{new} + \delta X_{new}
                $$
                $$
                \delta X_{new} = \sum_{i=0}^{ref} {w_{new,i} s_i \over w_{new,i}}
                $$
                </p>
            </div>
        </div>
    </div>
    <script src="{% static 'js/procrustes.js' %}"</script>
</body>
</html>
